#!/usr/bin/env python3
from workflow.workflow import Project
from workflow.scipion import Config
import argparse
import logging
import os
import sys


def _check_python_version_compatible():
    if sys.version_info < (3, 5):
        print('This application requires Python 3.5 or greater.\n',
              'Version',
              str(sys.version_info),
              'detected.'
              )
        sys.exit(1)


def _check_imod_installed():
    from shutil import which
    if which('imod') is None:
        print('This application requires imod be installed. Exiting')
        sys.exit(1)


def _check_scipion_installed():
    from shutil import which
    if which('scipion') is None:
        print('This application requires scipion be installed. Exiting')
        sys.exit(1)


def _parse_arguments():
    parser = argparse.ArgumentParser()
    parser.add_argument('--project', '-p',
                        required=False,
                        type=str,
                        help='Unique project identifier.')
    parser.add_argument('--src-pattern', '-s',
                        required=False,
                        type=str,
                        help='A globbing pattern to match files for import and\
                        processing. Usually matches the files directly output\
                        by the camera.')
    parser.add_argument('--frames', '-f',
                        required=False,
                        type=int,
                        help='Set to the number of frames that will need to be\
                        stacked per-movie. Defaults to 1 (already stacked).')
    parser.add_argument('-v', '--debug', '--verbosity',
                        required=False,
                        type=str,
                        help='Provide a verbosity level like INFO or DEBUG\n\
                        Defaults to the equivalent of --debug WARNING')
    parser.add_argument('--log-file', '-o',
                        required=False,
                        type=str,
                        help='Path to write log file.')
    args = parser.parse_args()
    return args


if __name__ == '__main__':
    _check_python_version_compatible()
    args = _parse_arguments()
    config = Config(**vars(args))
    config.generate_config()
    project_name = config.project_name or args.project
    logging.basicConfig(
        level=getattr(logging, args.debug) if args.debug else logging.INFO,
        filename=args.log_file or '/mnt/nas/pipeline/'+project_name+'.log')
    logging.getLogger('transitions').setLevel(logging.WARNING)
    _check_scipion_installed()
    _check_imod_installed()
    if os.fork():
        sys.exit()
    project = Project(project=project_name,
                      pattern=config.source_pattern or args.src_pattern,
                      frames=args.frames or 1,
                      scipion_config=config.scipion_config_path)
    project.start()
